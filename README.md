# Микросервис для скачивания файлов

Микросервис помогает работе основного сайта, сделанного на CMS и обслуживает
запросы на скачивание архивов с файлами. Микросервис не умеет ничего, кроме упаковки файлов
в архив. Закачиваются файлы на сервер через FTP или админку CMS.

Создание архива происходит на лету по запросу от пользователя. Архив не сохраняется на диске, вместо этого по мере упаковки он сразу отправляется пользователю на скачивание.

От неавторизованного доступа архив защищен хешом в адресе ссылки на скачивание, например: `http://host.ru/archive/3bea29ccabbbf64bdebcc055319c5745/`. Хеш задается названием каталога с файлами, выглядит структура каталога так:

```
- photos
    - 3bea29ccabbbf64bdebcc055319c5745
      - 1.jpg
      - 2.jpg
      - 3.jpg
    - af1ad8c76fda2e48ea9aed2937e972ea
      - 1.jpg
      - 2.jpg
```


## Как установить

Требования:
- Python 3.12+.
- Утилита zip в системе (для упаковки файлов в архив).

Установка зависимостей:

```bash
pip install -r requirements.txt
```

## Как запустить

```bash
python3 server.py
```

Сервер запустится на порту 8080, чтобы проверить его работу перейдите в браузере на страницу [http://127.0.0.1:8080/](http://127.0.0.1:8080/).

## Параметры командной строки

Скрипт поддерживает несколько опций:

```bash
python3 server.py [--files_path PATH] [--enable-delay] [--no-logs]
```

`--files_path`, `-p` -
путь к директории с файлами (корень, внутри которого лежат папки-хеши).
Если параметр не указан — используется значение из переменной окружения `FILES_PATH`
или test_photos по умолчанию.
```bash
python3 server.py -p photos
```

`--enable-delay`, `-d` -
включает искусственную задержку между отправкой чанков архива.
Используется для имитации медленного соединения.
```bash
python3 server.py -d
```
При включённой задержке сервер перед каждым чанком делает паузу на случайный интервал.
Флаг можно задать и через переменную окружения `ENABLE_DELAY=true`.

`--no-logs`, `-l` -
отключает логирование.
```bash
python3 server.py -l
```
Можно задать через переменную окружения `NO_LOGS=true`.

## Переменные окружения

Все флаги можно задавать и через переменные окружения (они используются как значения по умолчанию):

| Переменная     | Описание                                   | Значение по умолчанию |
|----------------|---------------------------------------------|------------------------|
| `FILES_PATH`   | Путь к каталогу с файлами                   | `test_photos`          |
| `ENABLE_DELAY` | `true` / `false` — включить задержку        | `false`                |
| `NO_LOGS`      | `true` / `false` — отключить логирование    | `false`                |

## Как развернуть на сервере

```bash
python3 server.py
```

После этого перенаправить на микросервис запросы, начинающиеся с `/archive/`. Например:

```
GET http://host.ru/archive/3bea29ccabbbf64bdebcc055319c5745/
GET http://host.ru/archive/af1ad8c76fda2e48ea9aed2937e972ea/
```

# Цели проекта

Код написан в учебных целях — это урок в курсе по Python и веб-разработке на сайте [Devman](https://dvmn.org).